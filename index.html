<html>
<head>
 <title>ascii video</title>
 <meta name="viewport" content="width=device-width,height=device-height">
 <link href="https://fonts.cdnfonts.com/css/droid-sans-mono-2" rel="stylesheet">
 <style>
  body {
   color: #ffffff;
   background-color: #000000;
   text-align: left;
   margin: 0;
   padding: 0;
   image-rendering: pixelated;
   font-family: 'Droid Sans Mono', monospace;
  }

  .button {
   background-color: #000;
   color: #fff;
   cursor: pointer;
   padding: 0px 2px;
   user-select: none;
  }

  .render #video {
   position: absolute;
  }

  .render #canvas {
   position: absolute;
   display: none;
   opacity: 50%;
  }
  .render #ASCIIvideo {
   font-family: 'Droid Sans Mono', monospace;
   font-size: 8px;
   letter-spacing: 0;
   background-color: #000000;
   margin: 0;
   padding-top: 0px;
   position: absolute;
  }
  .mark, .button {
   position: relative !important;
   display: inline-block !important;
  }
  .controls {
   font-size: 16.5px;
  }
  .controls #file {
   width: 0;
   height: 0;
   position: absolute;
  }
  .controls input {
   background-color: black;
   color: white;
   border: 0;
  }
 </style>
</head>
<body id="body">
 <div class='controls'>
  config{
  <br />
  <input type="file" accept="video/*" id="file" />
  <div class="mark" id="togglecamera" onclick="togglecamera()">
   camera: false;
  </div>
  <br />
  <label class="mark" id="filelabel" for="file">src: click this!;</label><br />
  width: <input type="number" min="1" max="10000" id="width" value="67" onchange="changewidth(this.value)" />;<br />
  <div class="mark" id="togglevideo" onclick="togglevideo();">
   loading
  </div>
  <br /><div class="mark" id="togglecolor" onclick="togglecolor();">
   loading
  </div>
  <br />
  <div class="mark" id="togglereverse" onclick="togglereverse()">
   loading
  </div>
  <br />
  brightness: <input class="mark" type="range" min="0.001" value="1" step="0.001" max="2" id="changebrightnesse" />;
  <br />
  bloom: <div class="mark" id="bloom" onclick="togglebloom();">
   loading
  </div>
  <br />
  }
 </div>
 <div class="controls">
  <div class="button" id="playpause" onclick="playPause();">
   Loading
  </div>
  <div class="mark" id='consolelog'>
   Loading
  </div>
 </div>
 <br />
 <div class='render'>
  <video id="video" width="100%" controls>
  </video>
  <canvas id='canvas'></canvas>
  <pre class="mark" id="ASCIIvideo" onclick="playPause();"></pre>
 </div>
 <script>
  //aku bikin banyak const :v gunanya untuk mengambil id mereka untuk di ubah property nya
  const body = document.getElementById('body');
  const fileinput = document.getElementById('file');
  const camerainput = document.getElementById('togglecamera');
  const filelabel = document.getElementById('filelabel');
  const widthinput = document.getElementById('width');
  const togglereversee = document.getElementById('togglereverse');
  togglereversee.innerHTML = 'theme: night;';
  const changebrightnesse = document.getElementById('changebrightnesse');
  const bloome = document.getElementById('bloom');
  bloome.innerHTML = 'false';
  const videotag = document.getElementById('video');
  const ASCIIvideo = document.getElementById('ASCIIvideo');
  const consolelog = document.getElementById('consolelog');
  const playpause = document.getElementById('playpause');
  const togglevideoe = document.getElementById('togglevideo');
  togglevideoe.innerHTML = 'color1: false;';
  const togglecolore = document.getElementById('togglecolor');
  togglecolore.innerHTML = 'color2: false;<font color="green">//lag</font>';

  fileinput.onchange = () => {
   //saat file di masukan maka
   const selectedFile = fileinput.files[0];
   console.log('loaded ' + selectedFile.name);
   if (selectedFile) {
    const videoURL = URL.createObjectURL(selectedFile); //file yang di pilih akan di jadikan source
    videotag.src = videoURL; //ubah source videotag sesuai yang ditetapkan videoURL
    vwidth = 0; //ini letak bingungku, sebelumnya video yang dimuat menghasilkan lebar null atau undefined jadi script nya error skippp ^_^
    videoload(); //karna source sudah ada kita panggil fungsi ini dan olah datanya di sana
    filelabel.innerHTML = 'src: "' + selectedFile.name + '";';
    brightness = 1;
    changebrightnesse.value = 1;
   } else {
    videotag.src = ''; //jika pas milih file tapi gk jadi alias di close jendela nya alias dikembaliin ke browser tanpa pilih file maka hapus src nya
   }
  }

  //menerapkan value awal di setiap variabel

  ///////
  var chars = "MBRROGSS3IIlli|¡;:``·· ";
  //ini karakter dari gelap ke terang,
  //menyesuaikan huruf itu susah,
  //tapi ini lah yang menurutku pas,
  //sebelumnya memakai font bawaan hp karna hurfnya bagus
  //sekarang udah di ubah, dan disesuaikan ulang huruf nya
  //kalau kamu punya font dan huruf ascii tersendiri silahkan di ganti
  ///////

  brightness = 1; //kecerahan ascii yang di generate
  bloom = false; //memberikan bayangan di teks biar lebih jelas warnanya hh
  var r = false; //reverse ubah dari gelap ke terang menjadi terang ke gelap
  chars.split(''); //kita ubah jadi array


  var w = 67; //67 jumlah karakter secara horizontal, alias lebar huruf yang di generate
  var c = false; //pewarnaan pada huruf default false aja karna lag banget
  var vc = false; //video color ini pewarnaan metode kedua, gk se bagus yg sebelumnya, tapi fps nya jauh lebih tinggi dari yang pertama
  var camera = false; //males cari video di perangkatmu? coba kamera aja wkwk

  var fps = 0; //untuk fps nanti value pertama 0 aja
  var render = false; //generate gambar jadi ascii kemudian di tampilkan, default matikan alias false

  function videoload() {

   //mengambil lebar dan tinggi element video
   vwidth = videotag.videoWidth;
   vheight = videotag.videoHeight;

   if (vwidth == 0) {
    //tadinya mau pake while tapi ntahlah

    //selagi lebar video 0 maka ulangi lagi
    requestAnimationFrame(videoload);
   } else {
    //jika bukan 0 maka lanjut persiapan data video


    //ubah menghitung tinggi huruf sesuai dengan lebar huruf
    h = (w / vwidth) * vheight;
    if (camera == true) {
     h = w;
    }
    canvas = document.getElementById('canvas');
    canvas.width = w; //ubah lebar canvas menjadi jumlah huruf yang horizontal
    canvas.height = Math.round(h * 0.7); //menggepengkan tinggi video, pixel itu kotak, sedangkan huruf nggak kotak, dia lebih tinggi, jadi kita gepengkan agar saat diterapkan ke huruf dan melebar nanti jadi pas lagi ukurannya
    s = 4.8; //skala mengubah ukuran canvas dan elemen video sesuai dengan jumlah huruf vertikal dan horizontal
    cw = w * s;
    ch = h * s;
    canvas.style.width = cw + 'px';
    canvas.style.height = ch +'px';
    lh = 0;
    ASCIIvideo.style.lineHeight = lh + 'px';
    videotag.style.width = cw + 'px';
    ctx = canvas.getContext("2d");
    ctx.drawImage(videotag, 0, 0, canvas.width, canvas.height);
    viddata = ctx.getImageData(0, 0, canvas.width, canvas.height).data;

    //memulai untuk mengisi huruf sesuai dengan lebar dan tinggi huruf yg sudah ditetapkan
    //gunanya untuk mengetahui apakah akibat line height css membuat susunan huruf menjadi lebih lonjong atau tidak
    asciiFrame = "";
    for (i = 0; i < viddata.length; i += 4) {
     asciiFrame += 'M';
     if ((i + 4) % (w * 4) === 0) {
      asciiFrame += "\n";
     }
    }
    ASCIIvideo.innerHTML = asciiFrame;

    //setelah terisi huruf M maka kita samakan
    //tinggi huruf dengan tinggi canvas
    while (ASCIIvideo.clientHeight < ch) {
     lh += 0.1;
     ASCIIvideo.style.lineHeight = lh+'px';
     render = false;
     videotag.pause();
     playpause.innerHTML = '<font color="blue">paused</font>';
    }
    //setelah selesai kita pas in element ascii ke tengah canvas ke tengah
    if (ASCIIvideo.clientHeight > ch) {
     ASCIIvideo.style.marginTop = (ch - ASCIIvideo.clientHeight) * 0.4;
    }
   }
  }

  //sebelumnya gk pake file upload,
  //langsung link ke source videonya,
  //jadi aku gk tau kapan fungsi ini di panggil.
  //saat ini menyebabkan error saat menekan 'play' saat tidak ada video yg di muat alias belum pilih kamera atau milih file
  videotoascii();
  //

  function videotoascii() {
   if (render) {
    //jika render true

    //di setiap frame kita tambahkan fps dengan 1;
    fps += 1;

    //taruh gambar video ke canvas
    ctx.drawImage(videotag, 0, 0, canvas.width, canvas.height);
    //lalu kita ambil data canvas nya, kita ambil warna per pixel
    viddata = ctx.getImageData(0, 0, canvas.width, canvas.height).data;
    asciiFrame = "";
    for (i = 0; i < viddata.length; i += 4) {
     //kita jadiin video yang berwarna menjadi hitam putih saja
     //karna huruf ascii adanya gelap ke terang saja...
     const r = viddata[i];
     const g = viddata[i + 1];
     const b = viddata[i + 2];
     grayscale = 0.2126 * r + 0.7152 * g + 0.0722 * b;
     //kita kasih brightness biar hasil generate jadi lebih terang atau pun lebih gelap.
     grayscale *= brightness;
     if (grayscale > 255) {
      //jika warnanya lebih dari
      grayscale = 255; //maka jadikan 255 aja, alias max 255
     }

     //setelah selesai menjadikan hitam putih, kita tetapkan huruf apa yg pas untuk data hitam putih tadi
     asciiIndex = Math.floor(grayscale / 255 * (chars.length - 1));
     asciiChar = chars[chars.length - 1 - asciiIndex];
     if (c) {
      //jika warna true maka
      //kasih warna, tapi lag bgt.
      asciiFrame += `<a style="color:rgb(${r},${g},${b})">${asciiChar}</a>`;
     } else {
      //jika false
      //maka jgn dikasih warna hh
      asciiFrame += asciiChar;
     }

     if ((i + 4) % (w * 4) === 0) {
      //kasih baris baru kalok udah mencapai lebar huruf angka 4 disana karna data canvas menghasilkan 4 data warna, red green blue dan tingkat transparan
      asciiFrame += "\n";
     }
    }
    //console.log('width:' + vwidth + ' height:' + vheight + ' ar:' + arw + ':' + arh + ' length:' + w + ' height:' + h + ' color:' + c)
    ASCIIvideo.innerHTML = asciiFrame;
   }

   //kita ulangi lagi untuk frame video berikutnya
   requestAnimationFrame(videotoascii);
  }

  function showfps() {
   //untuk menghitung fps
   consolelog.innerHTML = 'fps:' + fps;
   fps = 0;
  }
  setInterval(showfps, 1000); //jika sudah 1 detik maka panggil fungsi showfps agar menampilkan variabel fps yg sudah terhitung, kemudian menjadikan variable fps menjadi 0 lagi


  function playPause() {
   //fungsi semacam tombol
   //untuk merender dan menghentikan render
   //btw lebih cocok generate dibanding render kayaknya
   if (render) {
    //jika render true
    render = false; //maka dibikin false
    videotag.pause(); //dan video nya di pause
    playpause.innerHTML = 'paused';
   } else {
    render = true;
    videotag.play();
    playpause.innerHTML = 'played';
   }
  }
  function onLoad() {
   //saat halaman pertamakali di load maka jalankan beberapa perintah
   if (true) {
    //sembunyikan video? default true

    //jika true maka sembunyiin element videonya
    videotag.style.display = "none";
   } else {
    //jika false

    //maka video tetap tampil tapi elemen lainnya di kurangi opacity nya, alias dibikin transparan
    ASCIIvideo.style.opacity = "50%"
    canvas.style.opacity = "50%"
   }
   playpause.innerHTML = 'paused';
   //playVid();
  }
  function togglecamera() {
   //ada masalah!!!, aku gk tau cara hentiin kamera
   if (camera) {
    //jika kamera nyala dan mau dimatiin maka
    //aku minta kalian refresh aja wkwk
    alert("please refresh this page");
   } else {
    //jika kamera mati lalu ingin dinyalakan maka

    //script ini ku ambil di google, aku gk ngerti tentang kamera
    camera = true;
    camerainput.innerHTML = 'camera: true;';
    constraints = {
     video: {
      //atur lebar dan tinggi gambar yg di hasilin kamera
      width: w,
      height: w,

      facingMode: 'environment'//default kita ambil kamera belakang untuk pengguna mobile yg punya 2 kamera
     },
     audio: false
    };
    // Request access to the camera
    navigator.mediaDevices.getUserMedia(constraints)
    .then(stream => {
     videotag.srcObject = stream;
    })
    .catch(error => {
     console.error('Error accessing camera:', error);
     consolelog.innerHTML = 'error ' + error;
    });
    videoload();
   }
  }

  function changewidth(cwidth) {
   //ubah lebar teks
   if (cwidth >= 1) {
    w = cwidth;
    videoload();
   }
  }

  function togglevideo() {
   //saklar atau switch untuk ubah pewarnaan huruf
   if (ASCIIvideo.style.mixBlendMode == '') {
    canvas.style.display = "inline";
    //metode ini lancar bgt untuk pewarnaan, beda sama yg di atas tadi
    if (r) {
     ASCIIvideo.style.mixBlendMode = 'screen';
    } else {
     ASCIIvideo.style.mixBlendMode = 'darken';
    }
    togglevideoe.innerHTML = 'color1: true;';
    vc = true;
   } else {
    canvas.style.display = "none";
    ASCIIvideo.style.mixBlendMode = '';
    togglevideoe.innerHTML = 'color1: false;';
    vc = false;
   }
  }

  function togglecolor() {
   //ini bakal ubah value variabel c (color), ini bakal aktifin pewarnaan di setiap huruf ascii
   //tapi lag bgt, fps drop 50% lebih
   //mungkin tergantung spek device juga, ntahlah
   if (c) {
    c = false;
    togglecolore.innerHTML = 'color2: false;<font color="green">//lag</font>';
   } else {
    c = true;
    togglecolore.innerHTML = 'color2: true;<font color="green">//lag</font>';
   }
  }


  function togglereverse() {
   //ini untuk mengubah tema aja. tema terang otomatis warna hurufnya hitam
   if (r) {
    r = false;
    playpause.style.backgroundColor = widthinput.style.backgroundColor = ASCIIvideo.style.backgroundColor = body.style.backgroundColor = "black";
    playpause.style.color = widthinput.style.color = body.style.color = "white";
    togglereversee.innerHTML = 'theme: night;';
   } else {
    r = true;
    playpause.style.backgroundColor = widthinput.style.backgroundColor = ASCIIvideo.style.backgroundColor = body.style.backgroundColor = "white";
    playpause.style.color = widthinput.style.color = body.style.color = "black";
    togglereversee.innerHTML = 'theme: light;';
   }

   //ini agar saat ganti tema
   if (vc) {
    //nanti maka warna video di nonaktifkan lalu aktifkan jika sebelumnya sudah di aktifkan maka akan di matikan lalu di nyalakan lagi
    togglevideo();
    togglevideo();
   }
   if (bloom) {
    //bloom juga sama
    togglebloom();
    togglebloom();
   }

   //variabel temp itu temporary
   //untuk sementara
   temp = '';
   for (i = chars.length-1; i >= 0; i--) {
    //di sini selain warna, kita ubah juga urutan huruf
    //aku mau pake .reverse tapi gk bisa tuh, jadi aku pake ini untuk mereverse array dari variabel chars yg udah di tetapkan di paling atas
    temp += chars[i];
   }
   //consolelog.innerHTML = temp;
   chars = temp.split('');
  }

  //ini fungsi apa namanya lupa, dia gk pake function namafungsi() lagi
  //ini untuk mengubah brightness secara instan saat input range digeser(sebelumnya aku pake onchange tapi gk bagus untuk tau perubahan kecerahannya)
  changebrightnesse.addEventListener('input', function() {
   brightness = changebrightnesse.value;
  });


  function togglebloom() {
   //untuk memperjelas warna hh
   if (bloom) {
    ASCIIvideo.style.textShadow = "";
    bloome.innerHTML = 'false';
    bloom = false;
   } else {
    if (r) {
     ASCIIvideo.style.textShadow = "0 0 2px #000";
    } else {
     ASCIIvideo.style.textShadow = "0 0 1px #fff,0 0 3px #fff";
    }
    bloome.innerHTML = 'true';
    bloom = true;
   }
  }

  //onload() parent
  //ketika halaman di muat execute fungsi onload()
  if (window.attachEvent) {
   window.attachEvent('onload', onLoad());
  } else if (window.addEventListener) {
   window.addEventListener('load', onLoad(), false);
  } else {
   document.addEventListener('load', onLoad(), false);
  }

  //maaf jika comment nya gk bisa di pahami
  //silahkan sempurnakan script ini, edit dan jgn lupa harus hapus semua comment dariku(wibi9424) ya... ^_^
 </script>
</body>
</html>
